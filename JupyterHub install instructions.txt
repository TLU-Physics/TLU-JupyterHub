# Server IP 40.119.56.12
# Ubuntu 20.04.6 LTS

# TODO: add command to change the server time zone to Central
apt update
apt upgrade
# what should user directory permissions be?
adduser rspence@tlu.edu --force-badname
adduser cberggren@tlu.edu --force-badname

wget "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh"
bash Mambaforge-$(uname)-$(uname -m).sh -b -p /opt/mambaforge # has mamba 1.4.2, conda 23.3.1, python 3.10
export PATH=/opt/mambaforge/bin:/opt/mambaforge/condabin:$PATH
mamba init
mamba update mamba # got 1.5.0
mamba install anaconda -c anaconda # appears to be 2022.10 versions; mamba now 1.4.9
mamba install altair vega_datasets vega jupyterhub nbgrader oauthenticator # jupyterhub 4.0.2; nbgrader 0.8.2
cd /opt/mambaforge/etc/jupyter
cp /home/cberggren\@tlu.edu/jupyterhub_config-2023-09-v2.py ./jupyterhub_config.py
jupyterhub token cberggren@tlu.edu # and copy into config file
jupyterhub token tsauncy@tlu.edu # and copy into config file

### Setup for nbgrader for 2 classes

mkdir -p /usr/local/share/nbgrader/exchange
chmod ugo+rw /usr/local/share/nbgrader/exchange

mkdir /etc/jupyter
cp /home/cberggren\@tlu.edu/nbgrader_config-etc.py /etc/jupyter/nbgrader_config.py
adduser grader-coursephys371 --force-badname
adduser grader-coursephys241l --force-badname
adduser stud1@tlu.edu --force-badname

sudo -u grader-coursephys371 /opt/mambaforge/bin/nbgrader quickstart coursePHYS371
sudo -u grader-coursephys371 mkdir .jupyter
sudo -u grader-coursephys371 cp /home/cberggren\@tlu.edu/nbgrader_config-phys371.py ./.jupyter/nbgrader_config.py

sudo -u grader-coursephys241l /opt/mambaforge/bin/nbgrader quickstart coursePHYS241L
sudo -u grader-coursephys241l mkdir .jupyter
sudo -u grader-coursephys241l cp /home/cberggren\@tlu.edu/nbgrader_config-phys241l.py ./.jupyter/nbgrader_config.py

cd /usr/local/share
mkdir jupyter
cd jupyter
echo "" > nbgrader.log
chmod 666 nbgrader.log

# create various user directories
# update user lists inside the following script
./configure_nbgrader_extensions.sh
